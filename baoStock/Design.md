# 多因子模型设计（草稿）

## 因子的选取
### 因子选取说明
+ 市场情况：牛市、熊市、震荡市 
+ 流动性指标：货币供应量、美元指数、上海银行间拆借利率 （later phase）
+ 业绩指标：国家数据、大宗商品指数、海事服务（later phase）
+ 根据影响市场的情况，我们为了赋予因子可解释的意义，将因子分为以下N类(可能会不全):
    + 估值类因子: PB,PE,PS…代表着市场对于公司价值和表现的预估
    + 盈利类因子: ROA,ROE,Gross Margin…代表着公司的盈利能力
    + 成长类因子: Profit_Growth_Rate,Asset_Growth_Rate…代表着公司的成长能力
    + 波动类因子: 股价收益率在一定时间内的标准差…代表着股价的波动情况
    + 情绪类因子: 换手率…代表着市场对这支股票的‘情绪’
    + 动量类因子…
    + 分析师类因子…
    + 价值类因子…
    + 股东因子: 户均持股比例

### 股票池的划分
#### 按市值特征
经典的 Fama-French 三因素模型早已表明市值对股票的收益率有显著的影响，各种主动型投资基金也常常按照投资标的的市值进行风格划分， 而大、小市值股票的估值等指标存在整体性的水平差异，不具备可比性。 因此我们按照市值大小对股票池进行划分。
我们以沪深 300 指数(HS300)成分股做为大市值股票池，以中证 500 指数(ZZ500)的成分股做为中、小市值股票池。这样既做到了以市值 大小对股票进行大致划分，同时，由于这些指数在甄选成份股时不仅考 虑到市值，也考虑到流动性、近期业绩等因素，遇到公司合并、重组停 牌等事项时及时将相关股票剔除，并定期调整、更新成份股。这就相当 于我们的股票池已事先进行了一道清理程序，大大降低选到“黑天鹅”股 票的概率，减小换股时产生的冲击成本，而且明确了我们投资组合收益的比较基准。  

`（TODO: 如何去除相关性强的因子?）`

## 单因子回测分析

`(TODO: 因子进一步处理，去极值、中性化、标准化?)`   

参考：
https://www.ricequant.com/community/topic/702/单一因子有效性检测/2
https://www.ricequant.com/community/topic/4584/多因子模型的步骤梳理-以打分法为例
https://www.ricequant.com/community/topic/4559/多因子权重优化方法比较

### 测算因子有效性的步骤
+ Step1 将股票池里的样本股票按待测因子按由高到低的顺序分成五档，各占20%。分别计算每一档的月平均收益率。  

    计算步骤说明：  
    + for ‘因子截止日期’:
        + 根据 ‘因子截止日期’ get 因子值
        + 计算档位、因子排名
        + 循环根据不同‘因子截止日期’， 计算下期收益率、‘收益率排名’、

            股票代码 | 因子(&PE) | 因子截止日期 | 档位 | 因子排名 | 下期收益率 | 收益率排名 
            :-------|:---------|:-----------|:-----|:-------|:---------|:----------
            000001  | 21       | 2015-01-15 |一档  | 1       | 10%      |  2         
            000002  | 39       | 2015-01-15 |二档  | 2       | 10%      |  2        
            000003  | 39       | 2015-01-15 |二档  | 1       | 1%       |  5  
            000004  | 21       | 2015-01-15 |一档  | 3       | 1%       |  5            
            000005  | 39       | 2015-01-15 |二档  | 2       | 5%       |  3  
            000999  | 21       | 2015-01-15 |一档  | 4       | 5%       |  3              
            600001  | 39       | 2015-01-15 |二档  | 1       | 90%      |  6    
            300002  | 21       | 2015-01-15 |一档  | 7       | 90%      |  6            

  
        + 计算 ‘因子排名和下期收益率的相关系数’
        + groupby 档位，计算各档平均收益Ri


            股票池 | 因子(&PE)  | 因子截止日期 |档位  | 收益率Ri  | 因子排名和下期收益率的相关系数  | P值
            :-------|:---------|:----------|:-----|----------|:---------------------------|:---------
            HS300  | PE        | 2015-01-15 |一档    | 10%    | 0.02                      |0.01
            HS300  | PE        | 2015-01-15 |二档    | 10%    | 0.31                     | 0.05
            HS300  | PE        | 2015-01-15 |五档    | 90%   | 0.31                      |0.10
            HS300  | PE        | 2015-01-15 |一档    | 10%    | 0.02                      |0.01
            HS300  | PE        | 2015-01-15 |二档    | 10%     | 0.31                     | 0.05
            HS300  | PE        | 2015-01-15 |五档    | 90%    | 0.31                      |0.10


+ Step2 计算两次月平均收益率差，分别是:  
    TOP 20%(第一档)- BOTTOM 20%(第五档)，  ==> 各档平均收益 Ri; R1 - R5
    TOP 40%(第一、二档)- BOTTOM 40%(第四、五档)。==> (R1+ R2)/2 - (R4+R5)/2  

    股票池 | 因子(&PE)  | 因子截止日期 | 一档-五档（%） | 一二档-四五档（%）  
    :------|:---------|:-----------|:--------------|:----------------
    HS300  | PE        | 2015-01-15 | -0.76       | 0.02                     
    HS300  | PE        | 2015-02-15 | -0.76       | 0.31                   
    HS300  | PE        | 2015-03-15 | -2.07       | 0.31                   
    HS300  | PE        | 2015-04-15 | 10          | 0.02                    
    HS300  | PE        | 2015-05-15 | 10          | 0.31                  
    HS300  | PE        | 2015-06-15 | 90          | 0.31                   

+ Step3 计算上述收益率差的平均值。如果平均值为正，则该因子的影响总体是正向的，即因子值越大收益趋于越大;如果平均值为负，则反之。
+ Step4 计算每个因子的有效性。有效性的计算方法如下:  
    正向(负向)因子的有效性=月均收益率差为正(负)的月份数/总月份数。  

+ Step5 根据每个月份五档的因子排名与对应的平均收益率排名，计算其相关系数以及显著性检验的 P 值。`（TODO:DataFrame的corr和cov方法？ 需要用到numpy库？pearsonr？可以用TALIB？）`  

   因子 | 股票池     | 市场阶段  | 一档-五档（%） | 有效性 |一二档-四五档（%）| 有效性 | 相关系数 | P值 |
    :---|:----------|:---------|:-------------|:------|:--------------|:------|:--------|:----|
    PE | HS300 总体 | 总体      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |  

    计算方法：
    ```python
    import scipy.stats as stats  
    x = [76,81,78,76,76,78,76,78,98,88,76,66,44,67,65,59,87,77,79,85,68,76,77,98,99,98,87,67,78]    
    y = [43,33,23,34,31,51,56,43,44,45,32,33,28,39,31,38,21,27,43,46,41,41,48,56,55,45,68,54,33] 
    r, p=stats.pearsonr(x,y) 

    [out]:(0.39341862097439129, 0.034735931329532836)
    ```
+ Step6 对不同股票池进行反复计算得到下表  
 
    <center> Sample: 表1 有效性分析</center>  

    因子 | 股票池     | 市场阶段  | 一档-五档（%） | 有效性 |一二档-四五档（%）| 有效性 | 相关系数 | P值 |
    :---|:----------|:---------|:-------------|:------|:--------------|:------|:--------|:----|
    PE | HS300 总体 | 总体      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | HS300 总体 | 牛市      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | HS300 总体 | 熊市      | -2.07        | 50%  | 0.76           | 64%  | -0.20     | 0.02  |
    PE | HS300 总体 | 震荡      | 0.20         | 50%  | 0.76           | 58%  | 0.11      | 0.41  |
    PE | HS300 周期 | 总体      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | HS300 周期 | 牛市      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | HS300 周期 | 熊市      | -2.07        | 50%  | 0.76           | 64%  | -0.20     | 0.02  |
    PE | HS300 周期 | 震荡      | 0.20         | 50%  | 0.76           | 58%  | 0.11      | 0.41  |
    PE | HS300 非周期 | 总体      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | HS300 非周期 | 牛市      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | HS300 非周期 | 熊市      | -2.07        | 50%  | 0.76           | 64%  | -0.20     | 0.02  |
    PE | HS300 非周期 | 震荡      | 0.20         | 50%  | 0.76           | 58%  | 0.11      | 0.41  |
    PE | ZZ500 总体 | 总体      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | ZZ500 总体 | 牛市      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | ZZ500 总体 | 熊市      | -2.07        | 50%  | 0.76           | 64%  | -0.20     | 0.02  |
    PE | ZZ500 总体 | 震荡      | 0.20         | 50%  | 0.76           | 58%  | 0.11      | 0.41  |
    PE | ZZ500 周期 | 总体      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | ZZ500 周期 | 牛市      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | ZZ500 周期 | 熊市      | -2.07        | 50%  | 0.76           | 64%  | -0.20     | 0.02  |
    PE | ZZ500 周期 | 震荡      | 0.20         | 50%  | 0.76           | 58%  | 0.11      | 0.41  |
    PE | ZZ500 非周期 | 总体      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | ZZ500 非周期 | 牛市      |  -0.76       | 50%  | 0.76           | 55%  | -0.08    | 0.11 |
    PE | ZZ500 非周期 | 熊市      | -2.07        | 50%  | 0.76           | 64%  | -0.20     | 0.02  |
    PE | ZZ500 非周期 | 震荡      | 0.20         | 50%  | 0.76           | 58%  | 0.11      | 0.41  |

### 度量因子有效性的标准
+ 首先，看TOP 20%组合与BOTTOM 20%组合的月平均收益率差是否有显著差异，如果有显著差异，说明该因子具有一定的区分度。同时，有效性比较高，才能说明该因子效果的稳健性比较好，才能确保依据该因子选取的组合胜率比较高。
+ 其次，看TOP 40%组合与BOTTOM 40%组合的月平均收益率差是否显著且有效性是否较高。
+ 最后，观察五档组合的因子排名与其下期收益率排名 `（TODO：如何计算？）`的相关性是否显著，越显著说明因子对收益的影响越确定。

    因子排名和收益率排名计算：  

    股票代码 | 因子 | 档位 | 因子排名 | 下期收益率 | 收益率排名 | 因子排名和下期收益率的相关系数
    :-------|:----|:----|:--------|:------|:-------------|:------------------------
    000001  |  PE | 一档 | 1       | 10%   |  2           | 0.02
    000001  | PE | 一档  | 3       | 1%    |  5           | 0.02
    000001  | PE | 一档  | 5       | 5%    |  3           | 0.02
    000001  | PE | 一档  | 7       | 90%   |  6           | 0.02
    000002  | PE | 二档  | 1       | 10%   |  2           | 0.31
    000002  | PE | 二档  | 3       | 1%    |  5           | 0.31
    000002  | PE | 二档  | 5       | 5%    |  3           | 0.31
    000002  | PE | 二档  | 7       | 90%   |  6           | 0.31

### 按市场环境对因子有效性进行分析
考虑到不同的市场阶段和环境下，投资者的关注点或关注的指标有很大不同，指标的有效性也可能会表现出较大的差异，因此我们统计和分析了不同市场阶段(牛市、熊市和震荡市三种)的因子有效性，为构建多因子选股模型和指导实际投资提供更全面的信息。  
`（TODO: 需要检查牛熊转换的逻辑！）`   
HS300:   
牛市:2016年6月-2016年11月，2017年05月-2018年1月  
震荡:2017年2月-2017年4月 `(TODO: 时间太短? 至少需要六个月？)`  
熊市:2018 年 01 月- 2018 年 06 月  
ZZ500:   
牛市:2014 年 6 月- 2015年6月
震荡:2016 年 03 月-2017 年 10 月  
熊市:2018 年 01 月- 2018 年 6 月
## 因子有效性的汇总结果
根据下面条件对有效性分析表进行汇总：  
+ TOP 20%组合与 BOTTOM 20%组合的月平均收益率差显著(一般取0.5%以上 `P < 0.005?` )且有效性较高(一般在 60%之上)。  
+ TOP 40%组合与 BOTTOM 40%组合的月平均收益率差显著(一般取0.5%以上`P < 0.005?`)且有效性较高(一般在 60%之上)。
+ 在稳定性分析中，因子排名与下期收益率排名的线性关系显著(至少在 10%的水平上显著。i.e. P <= 0.10)。  

根据这三条规则 `（TODO: 改成打分制？）`  
同时满足1、2条件；因子排名与收益率排名在 5%的水平上显著。√√  
满足条件 1、2 中一个;因子排名与收益率排名在 10%的水平上显著。√  
在动量因子部分，“√+”表明前、后收益率符号一致，呈现动量效应; “√-”表明前、后收益率符号相反，呈现反转效应。  
不满足条件 1、2 中任一个。x  
“(√√)”， “(√)”代表平均收益率差显著和线性相关性显著，规则与“√√”， “√”相似，但其显著性反应的是有效性的反面，如正向的因子却得出了负的收益率差和负相关系数的结果，或负向因子却得出了正的收益率差和正相关系数。  

## 因子的权重
`TODO: 考虑机器学习？Linear Regression？`

目前考虑两个A股重要的因子-流通市值和ROE，验证！

## 因子的合成



PCA (principle component analysis)

https://www.ricequant.com/community/topic/550/用ricequant-做主成分分析法-pca-建立统计因子模型的一些分享


## 多因子模型回测检验
